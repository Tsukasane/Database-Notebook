# 数据库笔记（面授补充章节）

[TOC]

## Chapter 9 查询处理与优化

### 9.1 问题提出

一个查询往往有==多种==执行方案，每种方案的==效率不同==，差别很大。分布式系统中，累积的差距更大，将直接影响系统整体性能。找代价最小的执行方案——查询优化。

* 一个查询：多种SQL表达方式
* 一个SQL语句：多种等价的关系代数表达方式——==运算顺序==
* 一个表达式：每个运算多种不同实现算法——==e.g.是否使用索引==
* 两个相邻运算：多种不同传递数据的方式——==是否使用流水线==



### 9.2 定性优化——启发（经验）式

#### 中间结果最小

* 尽可能**早**地执行**选择**运算
* 尽可能**早**地执行**投影**运算
* 将**选择和笛卡尔积**运算**组成自然联接**
* **较小的**关系作为**联接运算的左参数**

* 举例：查询报考'6'号试卷的考生姓名
  * 优化前：$Q_1=\pi_{eename}(\sigma_{examinee.eeid=eeexam.eeid \quad AND \quad eid='6'}(examinee \times eeexam))$
  * 优化后：$Q_1=\pi_{eename}((\pi_{eeid}(\sigma_{eid='6'}(eeexam)))\infin(\pi_{eeid,eename}(examinee)))$



### 9.3 定量优化——代价估计

* 利用这些统计信息来估计实现各种关系代数运算的算法花费
* 这里提到的统计信息是经过简化的，实际系统的查询优化器通常包含更多的统计信息
* 查询树的==根节点==表达查询的结果





## Chapter 10 事务处理

### 10.1 数据管理

* 涉及的存储器

  * 易失性存储器：内存、cache存储器

  * 非易失性存储器：磁盘

  * 稳定存储器：存储在稳定存储器中的信息是绝不会丢失的

* 保护管理

  数据库的程序都是以事务为单位运行的

  

### 10.2 事务故障

#### 故障类型

* 事务故障：e.g. 运算溢出，转账时发现账面金额不足
* 系统故障：内存信息丢失，但未破坏外存中数据。e.g. CPU故障，突然停电
* 磁盘故障：e.g. 磁盘磁头碰撞、瞬时的强磁场干扰



### 10.3 事务恢复

#### 基本恢复技术

* 支撑材料

  * 备份：将数据库复制到磁带或者另一个磁盘上。备用数据称后备（后援）副本
  * 日志：系统自动记录数据库每一次更新活动的文件

* 故障后采取措施，将数据库恢复到一个一致性的状态

* 原则：==先写日志==，日志记录**将要**发生何种修改，DB表示**实际**发生何种修改

* 事务分类：

  * 圆满事务（有commit标识）

  * 夭折事务（只有begin transaction标识，无commit标识）

  * 举例：$\tau_0$圆满事务，$\tau_1$夭折事务

    $<\tau_0 \quad start >$

    $<\tau_0,\quad x,\quad 1000,\quad 950,\quad U >$  //记录名，id，更新前值，更新后值，更新操作

    $<\tau_0,\quad y,\quad 2000,\quad 2050,\quad U >$

    $<\tau_0 \quad commit >$

    $<\tau_1 \quad start >$

    $<\tau_1,\quad z,\quad 700,\quad 600,\quad U >$

* 恢复的基本操作：

  * 对圆满事务所做过的修改操作应执行redo，修改对象被赋予新记录值

  * 对夭折事务所做过的修改操作应进行undo

#### 事务故障恢复

* 撤销事务已对数据库所做的更改
* 措施
  * 反向扫描日志文件，查找该事务的更新操作
  * 对该事务的更新操作执行逆操作，即将事务更新前的旧值写入数据库
  * 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理
  * 如此直至读到该事务的开始标识，事务的故障恢复就完成了

#### 系统故障恢复

* 不一致状态原因
  * 未完成事务对数据库的更新已写入数据库
  * 已提交事务对数据库的更新未写入数据库
* 措施
  * 正向扫描日志文件，找出圆满事务，记入重做队列；找出夭折事务，记入撤销队列
  * 反向扫描日志，对撤销队列中事务$\tau_i$的每一个日志记录执行undo操作
  * 正向扫描日志文件，对重做队列中事务$\tau_i$的每一个日志记录执行redo操作
* Checkpoint检查点：只做最后一个检查点到故障时刻的undo和redo操作即可

#### 介质故障恢复

* 磁盘上数据文件和日志文件遭到破坏
* 措施
  * 装入最新的数据库后备副本，使数据库恢复到最近一次备份时的一致性状态
  * 装入相应的日志文件副本，重做已完成的事务





