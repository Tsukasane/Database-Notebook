# 数据库笔记（BNU MOOC版）

## Chapter 4 PostgreSQL应用

[TOC]

### 4.1 应用体系结构

#### 数据库系统结构

* 网络上的数据库系统将数据的表示、处理、存储分为两层、三层或多层。常见的有==C/S（Client/Server）结构== 和 ==B/S（Browser/Server）结构==

* SQL语言连接数据库，高级语言进行数据处理和表示。高级语言可以通过SDBC / JDBC / ADO等调用SQL
* C/S结构，包括服务器、客户机两层。需要针对不同的操作系统开发不同版本的软件，当系统升级时，每一台客户机都需要安装客户端新版本，维护和升级成本高。如腾讯QQ、网络多人游戏等的就是典型的基于C/S体系结构
* B/S结构，==多层结构：客户端——Web服务器——应用服务器——数据库服务器——数据库==。客户端不需要安装任何软件，只需要一个浏览器就能与服务器进行交互。只需要在服务器端维护升级，一般客户端不需要专门维护。很多采用ASP、PHP、JSP技术的网站就是典型的基于B/S体系结构的

#### Web与数据库

* Web与数据库是当今互联网上两大无处不在的关键基础技术

* **数据库** 管理具有严格的数据模型与数据模式，有标准查询语言SQL；**Web** 结构松散、随意、访问自由

* 浏览器和Web服务器主要使用HTML语言，应用程序通常使用高级语言编写的，**从HTML到SQL**需要两个桥梁，HTML与高级语言之间的CGI、ASP、JSP等桥梁，高级语言与数据库之间的JDBC、ODBC、ADO等桥梁

  

### 4.4 PG中的函数

#### PL/pgSQL语言与存储函数

* PG允许使用各种不同的程序设计语言来编写函数，特别是**内建了PL/pgSQL**。函数经编译和优化后，存储在数据库服务器中，可以反复被调用

* 存储函数具有以下优点：
  * 不需要额外的语法分析步骤
  * 降低了客户机和服务器之间的通信量
  * 便于实施业务规则

* PL/pgSQL语言与高级语言在功能上十分类似，但存在一些格式上的不同
  * pgSQL是非过程化的
  * PL/pgSQL是为PG扩展的过程语言
  * 数据操作和流程控制
  * ==用于创建存储函数==
  * ==基于块结构==，块中的每个声明和每条语句都是以分号结束，如果某子块在另一块中，那么该子块的==END保留字后面必须以分号结束==，函数体的最后一个END保留字后面可以省略分号

#### 语句规则

* PL/pgSQL可以使用pgSQL的所有数据类型来声明变量，比如integer、varchar、char等

  ```sql
  //定义一个整型变量uid
  uid integer;
  ```

  ```sql
  //变量achieve是小数点两边总共五个数字，后含两位小数的数值型
  achieve numeric(5,2);
  ```

* 变量名称: = 表达式 ——赋值语句

* ELSIF和ELSEIF等价

* 使用pgSQL语言创建存储函数

  ```sql
  //创建存储函数
  CREATE OR REPLACE FUNCTION add(INT, INT)
  	RETURNS INT
  	AS
  	$ $
  	DECLARE intsum INT;
  	BEGIN
  		SELECT $1+$2 INTO intsum;
  		RETURN intsum;
  	END;
  	$ $
  	LANGUAGE plpgsql
  ```

* 执行存储函数

  * **方法1**: ==SELECT== 函数名([参数1，参数2……]);，会存储函数执行返回的结果

  * **方法2**: ==PERFORM== 函数名([参数1，参数2……]);，调用执行存储函数，执行结果的内容无关紧要可以丢弃

* 删除存储函数
  * DROP FUNCTION 函数名([参数1，参数2……]);